<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.voyageone.service.daoext.bi.BiVtSalesProductExt">

    <insert id="insertWithList" parameterType="Map" useGeneratedKeys="true">
        INSERT INTO voyageone_bi_source.bi_bt_spider_product_${tableTitleName}
        <foreach collection="column" index="index" item="columnName" open="(" separator="," close=")">
            ${columnName}
        </foreach>
        VALUES
        <foreach collection="value" index="index" item="salesProductValuesList" separator=",">
            ${salesProductValuesList}
        </foreach>
        ON DUPLICATE KEY UPDATE
        <foreach collection="column" index="index" item="columnName" separator="," >
            ${columnName} = VALUES(${columnName})
        </foreach>
    </insert>

    <!-- 取得产品的bi信息 -->
    <select id="selectList" parameterType="Map" resultType="Map"><![CDATA[
		select
			num_iid, process_date, CAST(sum(pv) AS signed) pv, CAST(sum(uv) AS signed) uv, CAST(sum(cartNums) AS signed) cartNums, CAST(sum(collNums) AS signed) collNums
        from
			(
			select a.num_iid, DATE_FORMAT(DATE_ADD(a.process_date, INTERVAL 8 HOUR), '%Y-%m-%d') AS process_date, a.pv, a.uv, a.product_cart_increment as cartNums, a.product_collector_number as collNums
			from voyageone_bi_source.bi_bt_spider_product_${tableTitleName} a
			where
			a.cart_id = #{cartId}
			and a.channel_id = #{channelId}
			and (a.process_date <= convert_tz(concat(date_format(date_add(CURDATE(), interval -1 day),  '%Y-%m-%d'),' 23:59:59'), '+08:00', '+00:00')
			and convert_tz(concat(date_format(date_add(CURDATE(), interval -90 day),  '%Y-%m-%d'),' 00:00:00'), '+08:00', '+00:00') <= a.process_date)
			) bidata
		group by num_iid, process_date limit #{oIdx},#{oLimit}
	]]></select>

</mapper>
