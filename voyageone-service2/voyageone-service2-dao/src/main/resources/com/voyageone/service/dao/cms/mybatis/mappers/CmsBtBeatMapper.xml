<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.voyageone.service.dao.cms.sql">

    <insert id="cms_bt_beat_info_insertList">
        INSERT INTO voyageone_cms2.cms_bt_beat_info (
        task_id, num_iid, product_code, syn_flag, message, created, creater, modified, modifier
        ) VALUES
        <foreach collection="modelList" item="i" separator=",">
            (
            #{i.task_id}, #{i.num_iid}, #{i.product_code}, #{i.syn_flag}, #{i.message}, #{i.created}, #{i.creater},
            #{i.modified}, #{i.modifier}
            )
        </foreach>
    </insert>

    <update id="cms_bt_beat_info_updateNoCodeMessage">
        UPDATE voyageone_cms2.cms_bt_beat_info b
            JOIN voyageone_cms2.cms_bt_tasks t
                ON b.task_id = t.task_id
            LEFT JOIN voyageone_cms2.cms_bt_promotion_code pc
                ON pc.promotion_id = t.promotion_id
                   AND pc.product_code = b.product_code
        SET b.message = #{message},
        b.syn_flag = #{syn_flag}
        WHERE t.task_id = #{task_id}
              AND pc.seq IS NULL;
    </update>

    <update id="cms_bt_beat_info_updateNoNumiidMessage">
        UPDATE voyageone_cms2.cms_bt_beat_info b
            JOIN voyageone_cms2.cms_bt_tasks t
                ON b.task_id = t.task_id
            LEFT JOIN voyageone_cms2.cms_bt_promotion_model pm
                ON pm.promotion_id = t.promotion_id
                   AND pm.num_iid = b.num_iid
        SET b.message = #{message},
        b.syn_flag = #{syn_flag}
        WHERE t.task_id = #{task_id}
              AND pm.seq IS NULL;
    </update>

    <select id="cms_bt_beat_info_selectListByTask" resultType="com.voyageone.web2.cms.wsdl.models.CmsBtBeatInfoModel">
        SELECT
            id,
            task_id,
            num_iid,
            product_code,
            syn_flag,
            message,
            created,
            creater,
            modified,
            modifier
        FROM voyageone_cms2.cms_bt_beat_info
        WHERE task_id = #{task_id}
    </select>

    <select id="cms_bt_beat_info_selectListByTask_page" resultMap="beatInfoWithPromotionCode">
        SELECT
        id,
        b.task_id,
        b.num_iid,
        b.product_code,
        syn_flag,
        message,
        b.created,
        b.creater,
        b.modified,
        b.modifier,
        pc.promotion_price
        FROM voyageone_cms2.cms_bt_beat_info b
        JOIN voyageone_cms2.cms_bt_tasks t
        ON b.task_id = t.task_id
        LEFT JOIN voyageone_cms2.cms_bt_promotion_code pc
        ON t.promotion_id = pc.promotion_id
        AND b.product_code = pc.product_code
        WHERE t.task_id = #{task_id}
        <if test="flag != null">
            AND syn_flag = #{flag.flag}
        </if>
        LIMIT #{offset}, #{size}
    </select>

    <resultMap id="beatInfoWithPromotionCode" type="com.voyageone.web2.cms.wsdl.models.CmsBtBeatInfoModel" autoMapping="true">
        <id column="id" property="id"/>
        <association property="promotion_code" javaType="com.voyageone.web2.sdk.api.domain.CmsBtPromotionCodeModel">
            <result column="promotion_price" property="promotionPrice"/>
        </association>
    </resultMap>

    <select id="cms_bt_beat_info_selectListByTask_count" resultType="int">
        SELECT COUNT(1)
        FROM voyageone_cms2.cms_bt_beat_info
        WHERE task_id = #{task_id}
        <if test="flag != null">
            AND syn_flag = #{flag.flag}
        </if>
    </select>

    <delete id="cms_bt_beat_info_deleteByTask">
        DELETE FROM voyageone_cms2.cms_bt_beat_info
        WHERE task_id = #{task_id}
    </delete>

    <select id="cms_bt_beat_info_selectCountInFlags" resultType="int">
        SELECT COUNT(1)
        FROM voyageone_cms2.cms_bt_beat_info
        WHERE task_id = #{task_id}
        AND syn_flag IN (
        <foreach collection="flags" item="i" separator=",">
            #{i.flag}
        </foreach>
        )
    </select>

    <select id="cms_bt_beat_info_selectOneById" resultType="com.voyageone.web2.cms.wsdl.models.CmsBtBeatInfoModel">
        SELECT
            id,
            task_id,
            num_iid,
            product_code,
            syn_flag,
            message,
            created,
            creater,
            modified,
            modifier
        FROM voyageone_cms2.cms_bt_beat_info
        WHERE id = #{beat_id}
    </select>

    <update id="cms_bt_beat_info_updateFlag">
        UPDATE voyageone_cms2.cms_bt_beat_info
        SET syn_flag = #{syn_flag},
        modifier = #{modifier},
        modified = NOW()
        WHERE id = #{id}
              AND modified = #{modified}
    </update>

    <update id="cms_bt_beat_info_updateFlags">
        UPDATE voyageone_cms2.cms_bt_beat_info
        SET syn_flag = #{syn_flag},
        modifier = #{modifier},
        modified = NOW()
        WHERE task_id = #{task_id}
              AND syn_flag > 0;
    </update>

    <select id="cms_bt_beat_info_selectSummary" resultType="Map">
        SELECT
            syn_flag flag,
            count(1) count
        FROM voyageone_cms2.cms_bt_beat_info
        WHERE task_id = #{task_id}
        GROUP BY syn_flag
    </select>

    <select id="cms_bt_beat_info_selectOneByNumiidInPromotion" resultMap="beatInfoWithPromotion">
        <include refid="cms_bt_beat_info_join_promotion"/>
        WHERE p.promotion_id = #{promotion_id}
        AND b.num_iid = #{num_iid}
    </select>

    <select id="cms_bt_beat_info_selectOneByNumiid" resultType="com.voyageone.web2.cms.wsdl.models.CmsBtBeatInfoModel">
        SELECT
            id,
            task_id,
            num_iid,
            product_code,
            syn_flag,
            message,
            created,
            creater,
            modified,
            modifier
        FROM voyageone_cms2.cms_bt_beat_info
        WHERE task_id = #{task_id}
              AND num_iid = #{num_iid}
    </select>

    <select id="cms_bt_beat_info_selectListByNumiidInOtherTask" resultMap="beatInfoWithPromotion">
        <include refid="cms_bt_beat_info_join_promotion"/>
        WHERE p.promotion_id = #{promotion_id}
        AND b.num_iid = #{num_iid}
        AND b.task_id != #{task_id}
    </select>

    <sql id="cms_bt_beat_info_join_promotion">
        SELECT
            id,
            b.task_id,
            num_iid,
            product_code,
            syn_flag,
            message,
            b.created,
            b.creater,
            b.modified,
            b.modifier,
            p.promotion_id,
            channel_id,
            cart_id,
            promotion_status,
            promotion_name,
            pre_sale_end,
            pre_sale_start,
            pre_period_start,
            pre_period_end,
            activity_start,
            activity_end,
            tejiabao_id,
            promotion_type,
            ref_tag_id,
            is_active,
            is_all_promotion,
            p.created  p_created,
            p.creater  p_creater,
            p.modified p_modified,
            p.modifier p_modifier
        FROM voyageone_cms2.cms_bt_promotion p
            JOIN voyageone_cms2.cms_bt_tasks t
                ON p.promotion_id = t.promotion_id
            JOIN voyageone_cms2.cms_bt_beat_info b
                ON t.task_id = b.task_id
    </sql>

    <resultMap id="beatInfoWithPromotion" type="com.voyageone.web2.cms.wsdl.models.CmsBtBeatInfoModel" autoMapping="true">
        <association property="promotion" javaType="com.voyageone.web2.sdk.api.domain.CmsBtPromotionModel"
                     autoMapping="true">
            <result column="p_created" property="created"/>
            <result column="p_creater" property="creater"/>
            <result column="p_modified" property="modified"/>
            <result column="p_modifier" property="modifier"/>
        </association>
    </resultMap>

    <update id="cms_bt_beat_info_updateCode">
        UPDATE voyageone_cms2.cms_bt_beat_info
        SET product_code = #{product_code},
        modified = NOW(),
            modifier = #{modifier}
        WHERE id = #{id}
              AND modified = #{modified}
    </update>

</mapper>