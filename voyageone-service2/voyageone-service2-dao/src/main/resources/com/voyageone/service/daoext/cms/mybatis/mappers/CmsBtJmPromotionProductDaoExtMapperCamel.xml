<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.voyageone.service.daoext.cms.CmsBtJmPromotionProductDaoExt">
<resultMap id="ResultMap" type="CmsBtJmPromotionProductModel">

</resultMap>
<select id="getByProductCodeChannelIdCmsBtJmPromotionId"  resultMap="ResultMap">
    select  *   from cms_bt_jm_promotion_product  where  cms_bt_jm_promotion_id=#{cmsBtJmPromotionId} and  channel_id=#{channelId} and product_code=#{productCode} limit 1
</select>
<select id="getListByWhere" resultType="MapModel" >
    select  *   from cms_bt_jm_promotion_product
    <where>
        <if test="id != null">
            AND id = #{id}
        </if>
        <if test="channelId != null">
            AND channel_id = #{channelId}
        </if>
        <if test="cmsBtJmPromotionId != null">
            AND cms_bt_jm_promotion_id = #{cmsBtJmPromotionId}
        </if>
        <if test="cmsBtJmProductId != null">
            AND cms_bt_jm_product_id = #{cmsBtJmProductId}
        </if>
        <if test="productCode != null">
            AND product_code = #{productCode}
        </if>
        <if test="jmHashId != null">
            AND jm_hash_id = #{jmHashId}
        </if>
        <if test="limit != null">
            AND limit = #{limit}
        </if>
        <if test="marketPrice != null">
            AND market_price = #{marketPrice}
        </if>
        <if test="dealPrice != null">
            AND deal_price = #{dealPrice}
        </if>
        <if test="synchState != null">
            AND synch_state = #{synchState}
        </if>
        <if test="creater != null">
            AND creater = #{creater}
        </if>
        <if test="created != null">
            AND created = #{created}
        </if>
        <if test="modified != null">
            AND modified = #{modified}
        </if>
        <if test="modifier != null">
            AND modifier = #{modifier}
        </if>
        <if test="state != null">
            AND state = #{state}
        </if>
        <if test="appId != null">
            AND app_id = #{appId}
        </if>
        <if test="pcId != null">
            AND pc_id = #{pcId}
        </if>
        <if test="discount != null">
            AND discount = #{discount}
        </if>
        <if test="errorMsg != null">
            AND error_msg = #{errorMsg}
        </if>
        <if test="skuCount != null">
            AND sku_count = #{skuCount}
        </if>
    </where>
</select>
<select id="getExportInfoListByPromotionId" resultType="MapModel">
    SELECT a.`jm_hash_id`,a.`product_code`,a.`deal_price`,a.`market_price`,a.`discount`,a.`sku_count`,a.`quantity`,b.`product_name_cn`,`app_id`,`pc_id`

    FROM `cms_bt_jm_promotion_product`  AS a
    JOIN `cms_bt_jm_product`  AS b  ON a.`cms_bt_jm_product_id`=b.`id`
    WHERE a.`cms_bt_jm_promotion_id`= #{promotionId}
</select>
<select id="getListCmsBtJmImportProductByPromotionId" resultType="MapModel">
    SELECT b.*,a.`app_id`,a.`pc_id`,a.`limit`
    FROM `cms_bt_jm_promotion_product`  AS a
    JOIN `cms_bt_jm_product`  AS b  ON a.`cms_bt_jm_product_id`=b.`id`
    WHERE a.`cms_bt_jm_promotion_id`= #{promotionId}
</select>
<delete id="deleteByPromotionId">
    DELETE FROM `cms_bt_jm_promotion_product` WHERE `cms_bt_jm_promotion_id`=#{promotionId}
</delete>
<delete id="deleteByProductIdListInfo">
    DELETE  FROM `cms_bt_jm_promotion_product` WHERE `cms_bt_jm_promotion_id`=#{promotionId}
    and  `cms_bt_jm_product_id` in  <foreach item="item" index="i" collection="productIdList"
                                             open="(" separator="," close=")">
    #{item}
</foreach>
</delete>
<update id="jmNewUpdateAll">
    UPDATE  `cms_bt_jm_promotion_product` set update_state=1,error_msg=''  WHERE `cms_bt_jm_promotion_id`=#{promotionId}  and synch_state in (0,4)
</update>
<update id="jmNewByProductIdListInfo">
    UPDATE  `cms_bt_jm_promotion_product` set update_state=1,error_msg=''  WHERE `cms_bt_jm_promotion_id`=#{promotionId}
    and  `cms_bt_jm_product_id` in  <foreach item="item" index="i" collection="productIdList"
                                             open="(" separator="," close=")">
    #{item}
</foreach>
</update>
<update id="updateDealEndTimeAll">
    update cms_bt_jm_promotion_product set deal_end_time_state=1 where cms_bt_jm_promotion_id=#{promotionId} and deal_end_time=#{dealEndTime} and synch_state in (2,3)
</update>
<update id="updateDealEndTime">
    UPDATE  `cms_bt_jm_promotion_product` set deal_end_time_state=1 WHERE `cms_bt_jm_promotion_id`=#{promotionId} and deal_end_time=#{dealEndTime} and synch_state in (2,3)
    and  `cms_bt_jm_product_id` in  <foreach item="item" index="i" collection="productIdList"
                                             open="(" separator="," close=")">
    #{item}
</foreach>
</update>


    <!--jm2 begin-->
    <select id="getPageByWhere" resultType="MapModel">
        SELECT b.image1,a.product_Long_Name  AS productLongName,b.color_En,a.deal_Price AS colorEn,b.attribute
        ,a.retail_price,a.sale_price,a.msrp_rmb,a.jm_hash_id AS jmHashId,a.discount,a.sku_count AS skuCount
        ,a.error_msg AS errorMsg,a.synch_status,a.update_status,a.price_status
        FROM `cms_bt_jm_promotion_product` AS a
        JOIN  `cms_bt_jm_product`  AS b ON a.`product_code`=b.`product_code` AND a.`channel_id`=b.`channel_id`
        <where>
            <if test="cmsBtJmPromotionId!=null">
                and a.cms_bt_jm_promotion_id=#{cmsBtJmPromotionId}
            </if>
            <if test="productCode!=null">
                and    b.product_code  like CONCAT(#{productCode},'%')
            </if>
            <if test="categoryLv1Name!=null">
                and b.category_lv1_name =#{categoryLv1Name}
            </if>
            <if test="synchStateList.size()!=0">
                and  a.synch_state in
                <foreach item="item" index="i" collection="synchStateList"
                         open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="beginDiscount!=null">
                and a.discount>=#{beginDiscount}
            </if>
            <if test="endDiscount!=null">
                and  a.discount&lt;=#{endDiscount};
            </if>
            <if test="priceType=='msrp'">
                <if test="beginPrice!=null">
                    and   b.msrp>=#{beginPrice}
                </if>
                <if test="endPrice!=null">
                    and   b.msrp&lt;=#{endPrice}
                </if>
            </if>
            <if test="priceType=='marketPrice'">
                <if test="beginPrice!=null">
                    and    a.market_price>=#{beginPrice}
                </if>
                <if test="endPrice!=null">
                    and   a.market_price&lt;=#{endPrice}
                </if>
            </if>
            <if test="priceType=='dealPrice'">
                <if test="beginPrice!=null">
                    and  a.deal_price>=#{beginPrice}
                </if>
                <if test="endPrice!=null">
                    and  a.deal_price&lt;=#{endPrice}
                </if>
            </if>
            <if test="productNameCn!=null">
                and   b.product_name_cn  like CONCAT(#{productNameCn},'%')
            </if>
            <if test="state!=null">
                and  a.state=#{state}
            </if>
            <if test="brandName!=null">
                and  b.brand_name=#{brandName}
            </if>
            <if test="colorEn!=null">
                and    b.color_en=#{colorEn}
            </if>
        </where>
        order by a.id desc
        <if test="start != null and length != null">
            LIMIT #{start}, #{length}
        </if>
    </select>
    <select id="getCountByWhere" resultType="int">
        SELECT count(*)
        FROM `cms_bt_jm_promotion_product` AS a
        JOIN  `cms_bt_jm_product`  AS b ON a.`product_code`=b.`product_code` AND a.`channel_id`=b.`channel_id`
        <where>
            <if test="cmsBtJmPromotionId!=null">
                and a.cms_bt_jm_promotion_id=#{cmsBtJmPromotionId}
            </if>
            <if test="productCode!=null">
                and    b.product_code  like CONCAT(#{productCode},'%')
            </if>
            <if test="categoryLv1Name!=null">
                and b.category_lv1_name =#{categoryLv1Name}
            </if>
            <if test="synchStateList.size()!=0">
                and  a.synch_state in
                <foreach item="item" index="i" collection="synchStateList"
                         open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="beginDiscount!=null">
                and a.discount>=#{beginDiscount}
            </if>
            <if test="endDiscount!=null">
                and  a.discount&lt;=#{endDiscount};
            </if>
            <if test="priceType=='msrp'">
                <if test="beginPrice!=null">
                    and   b.msrp>=#{beginPrice}
                </if>
                <if test="endPrice!=null">
                    and   b.msrp&lt;=#{endPrice}
                </if>
            </if>
            <if test="priceType=='marketPrice'">
                <if test="beginPrice!=null">
                    and    a.market_price>=#{beginPrice}
                </if>
                <if test="endPrice!=null">
                    and   a.market_price&lt;=#{endPrice}
                </if>
            </if>
            <if test="priceType=='dealPrice'">
                <if test="beginPrice!=null">
                    and  a.deal_price>=#{beginPrice}
                </if>
                <if test="endPrice!=null">
                    and  a.deal_price&lt;=#{endPrice}
                </if>
            </if>
            <if test="productNameCn!=null">
                and   b.product_name_cn  like CONCAT(#{productNameCn},'%')
            </if>
            <if test="state!=null">
                and  a.state=#{state}
            </if>
            <if test="brandName!=null">
                and  b.brand_name=#{brandName}
            </if>
            <if test="colorEn!=null">
                and    b.color_en=#{colorEn}
            </if>
        </where>
    </select>

    <select id="existsCode" resultType="boolean">
        SELECT 1 FROM `cms_bt_jm_promotion_product` WHERE channel_id=#{channelId} and   product_code=#{productCode} and  #{activity_start} &lt;=`activity_end`  and   #{activity_end}>=`activity_begin` limit 1
    </select>
    <!--jm2 end-->
</mapper>