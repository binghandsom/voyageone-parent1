// Generated by CoffeeScript 1.9.3

/*
  @Name: DictItemController
  @Date: 2015-09-15 13:48:01

  @User: Jonas
  @Version: 0.0.1
 */

define([
  'cms'
], function (cms) {

  cms.controller('popDictCustomController', function ($scope, $dictionaryService, $modalInstance, $translate, notify) {

    $scope.vm = {
      valueType: 'CUSTOM',
      masterData: {},
      custom: { params: [] },
      customBody: {
        moduleName: '',
        userParam: {}
      }
    };

    $scope.initialize = initialize;
    $scope.save = save;
    $scope.cancel = cancel;
    $scope.editDictionary = editDictionary;
    $scope.resetValue = resetValue;

    function initialize() {
      $dictionaryService.getCustoms().then(function (res) {
        $scope.vm.masterData = res.data;
      });
    }

    /**
     * 保存现有数据到主页面
     */
    function save () {
      var data = {
        type: $scope.vm.valueType,
        value: $scope.vm.customBody
      };
      $modalInstance.close(data);
      notify.success ($translate.instant('TXT_COM_UPDATE_SUCCESS'));
      $scope.$close();
    }

    /**
     * 取消新添加数据
     */
    function cancel () {
      $scope.vm.custom = { params: [] };
      $scope.vm.customBody = {
        moduleName: '',
        userParam: {}
      };

      $scope.$close();
    }

    /**
     * 修改一个原有的字典项
     * @param info
     * @param index
     */
    function editDictionary (info, name) {
      if(!_.isUndefined(info))
        $scope.vm.customBody.userParam[name] = angular.toJson({ruleWordList: info});
    }

    /**
     * 清空上次被设置的值
     */
    function resetValue () {
      $scope.vm.customBody = {
        moduleName: $scope.vm.custom.word_name,
        userParam: {}
      };

      // 初始化每个自定义字典的项目
      _.forEach($scope.vm.custom.params, function (param) {
        $scope.vm.customBody.userParam[param.param_name] = null;
      })
    }
  });
});
