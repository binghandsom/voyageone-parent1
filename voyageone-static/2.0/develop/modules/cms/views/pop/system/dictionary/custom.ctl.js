// Generated by CoffeeScript 1.9.3

/*
  @Name: DictItemController
  @Date: 2015-09-15 13:48:01

  @User: Jonas
  @Version: 0.0.1
 */

define([
  'cms'
], function (cms) {

  cms.controller('popDictCustomController', function ($scope, $dictionaryService, $modalInstance, $translate, notify, customValue) {

    $scope.vm = {
      masterData: {},
      valueTypes: {
        custom: 'CUSTOM'
      },
      // 选中的自定义字典对象
      customInfo: { params: [] }
    };

    $scope.initialize = initialize;
    $scope.save = save;
    $scope.cancel = cancel;
    $scope.editDictionary = editDictionary;
    $scope.resetValue = resetValue;

    function initialize() {
      $dictionaryService.getCustoms().then(function (res) {
        $scope.vm.masterData = res.data;

        if (!_.isUndefined(customValue)) {
          var customInfo = customValue.value;
          // 判断当前custom属于哪个custom
          _.forEach($scope.vm.masterData.customs, function (custom) {
            if (_.isEqual(custom.word_name, customInfo.moduleName)) {
              $scope.vm.customInfo = custom;
              // 为当前匹配的custom设置值
              _.forEach($scope.vm.customInfo.params, function (param) {
                param.value = customInfo.userParam[param.param_name] != null ? customInfo.userParam[param.param_name].ruleWordList : null;
              })
            }
          })
        }
      });
    }

    /**
     * 保存现有数据到主页面
     */
    function save () {
      var data = {
        type: $scope.vm.valueTypes.custom,
        value: {
          moduleName: $scope.vm.customInfo.word_name,
          userParam: _getUserParam()
        }
      };
      $modalInstance.close(data);
      notify.success ($translate.instant('TXT_COM_UPDATE_SUCCESS'));
      $scope.$close();
    }

    /**
     * 取消新添加数据
     */
    function cancel () {
      $scope.vm.customInfo = { params: [] };

      $scope.$close();
    }

    /**
     * 修改一个原有的字典项
     * @param info
     * @param index
     */
    function editDictionary (info, index) {
      if(!_.isUndefined(info)) {
        $scope.vm.customInfo.params[index].value = info;
      }
    }

    /**
     * 清空上次被设置的值
     */
    function resetValue () {

      // 初始化每个自定义字典的项目
      _.forEach($scope.vm.customInfo.params, function (param) {
        param.value = null;
      })
    }

    /**
     * 返回userparam对象
     * @returns {{}}
     * @private
     */
    function _getUserParam () {
      var tempUserParam = {};

      _.forEach($scope.vm.customInfo.params, function (param) {
        tempUserParam[param.param_name] = param.value != null ? {ruleWordList: param.value} : null;
      });

      return tempUserParam;
    }
  });
});
