<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.voyageone.web2.cms.sql">

    <insert id="cms_bt_tasks_insert" parameterType="com.voyageone.web2.cms.model.CmsBtTaskModel">
        INSERT INTO voyageone_cms2.cms_bt_tasks (
            task_name, task_type, promotion_id, config, created, creater, modified, modifier
        ) VALUES (
            #{task_name}, #{task_type}, #{promotion_id}, #{config}, #{created}, #{creater}, #{modified}, #{modifier}
        )
    </insert>

    <update id="cms_bt_tasks_update">
        UPDATE voyageone_cms2.cms_bt_tasks
        SET task_name = #{task_name},
        config = #{config},
        modified = NOW(),
            modifier  = #{modifier}
        WHERE task_id = #{task_id}
              AND modified = #{modified}
    </update>

    <select id="cms_bt_tasks_selectTaskWithPromotionByChannel" resultMap="taskWithPromotion">
        SELECT
            task_id,
            task_name,
            task_type,
            t.promotion_id,
            config,
            t.created,
            t.creater,
            t.modified,
            t.modifier,
            channel_id,
            cart_id,
            promotion_status,
            promotion_name,
            pre_sale_end,
            pre_sale_start,
            pre_period_start,
            pre_period_end,
            activity_start,
            activity_end,
            tejiabao_id,
            promotion_type,
            ref_tag_id,
            is_active,
            is_all_promotion,
            p.created p_created,
            p.creater p_creater,
            p.modified p_modified,
            p.modifier p_modifier
        FROM voyageone_cms2.cms_bt_tasks t
            JOIN voyageone_cms2.cms_bt_promotion p
                ON t.promotion_id = p.promotion_id
        WHERE p.channel_id = #{channel_id};
    </select>

    <resultMap id="taskWithPromotion" type="com.voyageone.web2.cms.model.CmsBtTaskModel" autoMapping="true">
        <id property="task_id" column="task_id"/>
        <association property="promotion" autoMapping="true" javaType="com.voyageone.web2.sdk.api.domain.CmsBtPromotionModel">
            <id property="promotionId" column="promotion_id"/>
            <result property="channelId" column="channel_id"/>
            <result property="cartId" column="cart_id"/>
            <result property="promotionStatus" column="promotion_status"/>
            <result property="promotionName" column="promotion_name"/>
            <result property="preSaleEnd" column="pre_sale_end"/>
            <result property="preSaleStart" column="pre_sale_start"/>
            <result property="prePeriodStart" column="pre_period_start"/>
            <result property="prePeriodEnd" column="pre_period_end"/>
            <result property="activityStart" column="activity_start"/>
            <result property="activityEnd" column="activity_end"/>
            <result property="tejiabaoId" column="tejiabao_id"/>
            <result property="promotionType" column="promotion_type"/>
            <result property="refTagId" column="ref_tag_id"/>
            <result property="isActive" column="is_active"/>
            <result property="isAllPromotion" column="is_all_promotion"/>
            <result property="created" column="p_created"/>
            <result property="creater" column="p_creater"/>
            <result property="modified" column="p_modified"/>
            <result property="modifier" column="p_modifier"/>
        </association>
    </resultMap>

    <select id="cms_bt_tasks_selectByIdWithPromotion" resultMap="taskWithPromotion">
        SELECT
            task_id,
            task_name,
            task_type,
            t.promotion_id,
            config,
            t.created,
            t.creater,
            t.modified,
            t.modifier,
            channel_id,
            cart_id,
            promotion_status,
            promotion_name,
            pre_sale_end,
            pre_sale_start,
            pre_period_start,
            pre_period_end,
            activity_start,
            activity_end,
            tejiabao_id,
            promotion_type,
            ref_tag_id,
            is_active,
            is_all_promotion,
            p.created p_created,
            p.creater p_creater,
            p.modified p_modified,
            p.modifier p_modifier
        FROM voyageone_cms2.cms_bt_tasks t
            JOIN voyageone_cms2.cms_bt_promotion p
                ON t.promotion_id = p.promotion_id
        WHERE task_id = #{task_id}
    </select>

    <select id="cms_bt_tasks_selectByName" resultType="com.voyageone.web2.cms.model.CmsBtTaskModel">
        SELECT
            task_id,
            task_name,
            task_type,
            promotion_id,
            config,
            created,
            creater,
            modified,
            modifier
        FROM voyageone_cms2.cms_bt_tasks
        WHERE promotion_id = #{promotion_id}
              AND task_name = #{task_name}
              AND task_type = #{task_type}
    </select>

</mapper>