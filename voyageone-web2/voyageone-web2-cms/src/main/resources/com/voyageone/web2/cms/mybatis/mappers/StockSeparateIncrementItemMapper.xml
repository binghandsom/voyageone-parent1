<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.voyageone.web2.cms.sql">

    <select id="select_stock_separate_increment" resultType="HashMap" parameterType="HashMap">
        select
            t1.sku,
            t1.increment_qty,
            t1.status,
            t2.cart_id,
            t2.task_id
        from voyageone_cms2.cms_bt_stock_separate_increment_item${tableNameSuffix} t1
        inner join voyageone_cms2.cms_bt_stock_separate_increment_task t2 on t1.sub_task_id = t2.sub_task_id
        where 1=1
            <if test="skuList != null and skuList.size() > 0">
                and (sku in
                <foreach collection="skuList" item="skuItem" open="(" separator="," close=")">
                    #{skuItem}
                </foreach>
                )
            </if>
            <if test="statusList != null and statusList.size() > 0">
                and (status in
                <foreach collection="statusList" item="statusItem" open="(" separator="," close=")">
                    #{statusItem}
                </foreach>
                )
            </if>
    </select>

    <select id="select_stock_separate_increment_success_qty" resultType="int" parameterType="HashMap">
        select sum(increment_qty) as increment_qty_sum
        from voyageone_cms2.cms_bt_stock_separate_increment_item
        where sku = #{sku}
        and status = #{status}
    </select>

    <select id="select_stock_separate_increment_item_by_status" resultType="Integer" parameterType="HashMap">
        select seq
        from   voyageone_cms2.cms_bt_stock_separate_increment_item
        where sub_task_id = #{subTaskId}
        <if test="statusList != null and statusList.size() > 0">
            and (status in
            <foreach collection="statusList" item="statusItem" open="(" separator="," close=")">
                #{statusItem}
            </foreach>
            )
        </if>
        limit 0,1
    </select>

    <select id="select_stock_separate_increment_item_status_cnt" resultType="int" parameterType="HashMap">
        select count(*)
        from   voyageone_cms2.cms_bt_stock_separate_increment_item
        where sub_task_id = #{subTaskId}
          and status != '0'
    </select>

    <select id="select_stock_separate_increment_item_history_cnt" resultType="int" parameterType="HashMap">
        select count(*)
        from   voyageone_cms2.cms_bt_stock_separate_increment_item_history
        where sub_task_id = #{subTaskId}
    </select>

    <update id="update_stock_separate_increment_item" parameterType="HashMap" >
        update voyageone_cms2.cms_bt_stock_separate_increment_item
        <set >
            <if test="qty != null" >
                qty = #{qty},
            </if>
            <if test="incrementQty != null" >
                increment_qty = #{incrementQty},
            </if>
            <if test="errorMsg != null" >
                error_msg = #{errorMsg},
            </if>
            <if test="errorTime != null" >
                error_time = #{errorTime},
            </if>
            <if test="separateTime != null" >
                separate_time = #{separateTime},
            </if>
            <if test="restoreTime != null" >
                restore_time = #{restoreTime},
            </if>
            <if test="status != null" >
                status = #{status},
            </if>
            <if test="fixFlg != null" >
                fix_flg = #{fixFlg},
            </if>
            modified = now(),
            <if test="modifier != null" >
                modifier = #{modifier},
            </if>
        </set>
        <where>
            1 = 1
            <if test="seq != null" >
                and seq = #{seq}
            </if>
            <if test="subTaskId != null" >
                and sub_task_id = #{subTaskId}
            </if>
            <if test="subTaskIdList != null and subTaskIdList.size() > 0">
                and (sub_task_id in
                <foreach collection="subTaskIdList" item="subTaskIdItem" open="(" separator="," close=")">
                    #{subTaskIdItem}
                </foreach>
                )
            </if>
            <if test="sku != null" >
                and sku = #{sku}
            </if>
            <if test="statusWhere != null" >
                and status = #{statusWhere}
            </if>
        </where>
    </update>

    <delete id="delete_stock_separate_increment_item" parameterType="HashMap">
        delete
        from voyageone_cms2.cms_bt_stock_separate_increment_item
        where
        sub_task_id = #{subTaskId}
        <if test="sku != null" >
            and sku = #{sku}
        </if>
    </delete>

    <select id="select_stock_separate_increment_item_excel_map" resultType="com.voyageone.web2.cms.bean.promotion.task.StockIncrementExcelBean" parameterType="HashMap">
        select
        `product_model`,
        `product_code`,
        `sku`,
        `property1`,
        `property2`,
        `property3`,
        `property4`,
        `qty`,
        `increment_qty`,
        `status`,
        `fix_flg`
        from ${tableName}
        ${whereSql}
        order by
        `product_model`,`product_code`,`sku`
    </select>

    <select id="select_stock_separate_increment_platform" resultType="HashMap" parameterType="String">
        SELECT
          t1.task_id,
          t1.promotion_id,
	      t2.activity_start,
	      t2.activity_end
        FROM
          voyageone_cms2.cms_bt_stock_separate_increment_task main
        LEFT OUTER JOIN voyageone_cms2.cms_bt_stock_separate_platform_info t1 ON main.task_id=t1.task_id AND main.cart_id=t1.cart_id
        LEFT OUTER JOIN voyageone_cms2.cms_bt_promotion t2 ON t1.promotion_id = t2.promotion_id
        WHERE
	      main.sub_task_id = #{subTaskId}
    </select>
</mapper>