<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.voyageone.cms.sql">
       <!--<select id="ims_promotion_select" resultType="HashMap">-->
              <!--SELECT-->
                  <!--t1.*, floor(t2.cn_price_final_rmb*100) as cnPriceFinalRmb-->
              <!--FROM-->
                  <!--(-->
                      <!--SELECT-->
                          <!--a.product_id,-->
                          <!--a.num_iid,-->
                          <!--a.channel_id,-->
                          <!--a.cart_id,-->
                          <!--a.promotion_add_status,-->
                          <!--a.publish_promotion_price_status-->
                      <!--FROM-->
                          <!--voyageone_ims.ims_bt_product a-->
                      <!--WHERE-->
                          <!--a.channel_id = #{channelId}-->
                      <!--AND a.cart_id = #{cartId}-->
                      <!--AND a.num_iid != '0'-->
                      <!--AND a.publish_promotion_price_status = 0-->
                  <!--) t1-->
              <!--LEFT JOIN voyageone_cms.cms_bt_cn_product_share t2 ON t1.product_id = t2.product_id-->
              <!--AND t1.cart_id = t2.cart_id-->
       <!--</select>-->
    <resultMap type="HashMap" id="PromotionMap">
        <result column="promotion_id" property="promotionId"/>
        <result column="num_iid" property="num_iid"/>
        <result column="channel_id" property="channel_id"/>
        <collection property="productList" javaType="ArrayList" ofType="HashMap" >
            <result column="product_code" property="product_code" />
            <collection property="skuList" javaType="ArrayList" ofType="HashMap" >
                <result column="promotion_price" property="promotionPrice" />
                <result column="product_sku" property="sku"/>
            </collection>
        </collection>
    </resultMap>
    <select id="cms_promotion_select" resultMap="PromotionMap" parameterType="HashMap">
        SELECT
            t2.channel_id,
            t1.promotion_id,
            t1.num_iid,
            t2.product_code,
            t2.product_sku,
            IFNULL(t2.promotion_price,'') as promotion_price
        FROM
            (
                SELECT
                    promotion_id,
                    num_iid
                FROM
                    `cms_bt_promotion_task`
                WHERE
                    syn_flg = 1
                AND task_type = 0
                AND promotion_id IN (
                    SELECT
                        promotion_id
                    FROM
                        cms_bt_promotion
                    WHERE
                        channel_id = '013'
                    AND is_active = 1
                    AND promotion_status = 0
                    AND cart_id = '23'
                )
                AND num_iid != ''
                GROUP BY
                    promotion_id,
                    num_iid
            ) t1
        LEFT JOIN (
            SELECT
                prom.channel_id,
                sku.promotion_id,
                sku.product_code,
                sku.product_sku,
                sku.num_iid,
                `code`.promotion_price
            FROM
                cms_bt_promotion_sku sku
            LEFT JOIN cms_bt_promotion_code `code` ON sku.promotion_id = `code`.promotion_id
            AND sku.product_code = `code`.product_code
            LEFT JOIN cms_bt_promotion prom on sku.promotion_id = prom.promotion_id
        ) t2 ON t1.promotion_id = t2.promotion_id
        AND t1.num_iid = t2.num_iid
    </select>
       <update id="ims_promotion_update" parameterType="HashMap">
              UPDATE voyageone_ims.ims_bt_product
              SET publish_promotion_price_status = #{priceStatus},
              promotion_faild_comment = #{promotionFaildComment},
              modified = now(),
              modifier = 'ImsPromotionJob'
              WHERE
                  cart_id = #{cartId}
              <if test="numIid != null and numIid.size > 0">
                  AND num_iid IN
              <foreach item="item" index="index" collection="numIid" open="(" separator="," close=")">
                     #{item}
              </foreach>
              </if>
       </update>
</mapper>
